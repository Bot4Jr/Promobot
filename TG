#!/bin/bash

THIS_DIR=$(cd "$(dirname "$0")"; pwd)
install_pkg="git wget unzip make autoconf c++ g++ install f a build expat tmux screen openssl coreutils g++4.7 c++4.7 lua5.2 liblua5.2 liblua5.2-dev fortune-mod fortunes libc6 libpcre3-dev libssl-dev  libreadline-dev libconfig-dev libevent-dev libjansson-dev libpython-dev libexpat1-dev libexpat1 libconfig libreadline lua-socket lua-sec lua-expat redis-server luarocks lua5.2 liblua5.2-dev"
today=`date +%F`
luarocks_version=2.4.2

lualibs=(
'luasec'
'socket'
'luarepl'
'lbase64'
'luafilesystem'
'lub'
'auth'
'lua-term'
'Lua-cURL'
'multipart-post'
'lanes'
'luaexpat'
'redis-lua'
'lua-cjson'
'fakeredis'
'xml'
'dkjson'
'feedparser'
'serpent'
)

function logo() {
    declare -A logo
    seconds="0.002"
logo[0]="  .          '||    ||' '||'''|  '||    ||' '||'|.  '||'''|  '||''|."
logo[1]=".||.   ... .  |||  |||   || .     |||  |||   ||  ||  || .     ||   ||"
logo[2]=" ||   || ||   |'|..'||   ||'|     |'|..'||   ||''|.  ||'|     ||''|'"
logo[3]=" ||    |''    | '|' ||   ||       | '|' ||   ||   || ||       ||   |."
logo[4]=" '|.' '|||.  .|. | .||. .||....| .|. | .||. .||..|' .||....| .||.  '|'"
logo[5]="    .|...'"
logo[6]=""
logo[7]="Channel : @tgMember"
logo[8]="Develop by @sajjad_021"
printf "\e[38;5;213m\t"
    for i in ${!logo[@]}; do
        for x in `seq 0 ${#logo[$i]}`; do
            printf "${logo[$i]:$x:1}"
            sleep $seconds
        done
        printf "\n\t"
    done
printf "\n"
}

function update() {
  sudo git pull
  sudo git fetch --all
  sudo git reset --hard origin/master
  sudo git pull origin master
  sudo chmod +x TG
}

pkg=(
'git'
'wget'
'unzip'
'make'
'autoconf'
'c++'
'g++'
'install'
'f'
'a'
'build'
'expat'
'tmux'
'screen'
'openssl'
'coreutils'
'g++4.7'
'c++4.7'
'lua5.2'
'libconfig-dev'
'liblua5.2'
'liblua5.2-dev'
'fortune-mod'
'fortunes'
'libc6'
'libpcre3-dev'
'libssl-dev'
'libreadline-dev'
'libconfig-dev'
'libevent-dev'
'libjansson-dev'
'libpython-dev'
'libexpat1-dev'
'libexpat1'
'libconfig'
'libreadline'
'lua-socket'
'lua-sec'
'lua-expat'
'redis-server'
'luarocks'
'lua5.2'
'liblua5.2-dev'
)
installation() {
for i in $(seq 1 100); do
sudo apt-get install $install_pkg -y &>/dev/null
    sleep 0.04
    if [ $i -eq 100 ]; then
        echo -e "XXX\n100\nDone!\nXXX"
    elif [ $(($i % 4)) -eq 0 ]; then
        let "is = $i / 4"
        echo -e "XXX\n$i\n${pkg[is]}\nXXX"
    else
        echo $i
    fi 
done | whiptail --title 'TeleGram Advertising bot Install and Configuration' --gauge "${pkg[0]}" 6 60 0
}
get_sub() {
    local flag=false c count cr=$'\r' nl=$'\n'
    while IFS='' read -d '' -rn 1 c; do
        if $flag; then
            printf '%c' "$c"
        else
            if [[ $c != $cr && $c != $nl ]]; then
                count=0
            else
                ((count++))
                if ((count > 1)); then
                    flag=true
                fi
            fi
        fi
    done
}
get_firstname_by_username() {
	user=`./bin/telegram-cli --disable-link-preview -C -R -D -e \
	'resolve_username '${1}'' 2>/dev/null`
    space_index=`echo ${user} | tr -cd ' '  | wc -c`
	msg=null
	if [[ ! ${user} ]] || [[ ${user} =~ 400 ]]; then
		echo $msg
	else
		msg=`echo ${user} | cut -d ' ' -f${space_index}- | cut -d ' ' -f1`
		echo "${msg}"
	fi
}
make_progress() {
exe=`lua <<-EOF
    print(tonumber($1)/tonumber($2)*100)
EOF
`
    echo ${exe:0:4}
}
download_libs_lua() {
    local i
    for ((i=0;i<${#lualibs[@]};i++)); do
        printf "\r\33[2K"
        printf "\rtgMember: please wait... [`make_progress $(($i+1)) ${#lualibs[@]}`%%] [$(($i+1))/${#lualibs[@]}] ${lualibs[$i]}"
        "$HOME"/.luarocks/bin/luarocks install ${lualibs[$i]} &>/dev/null
    done
    sleep 0.2
}
configure() {
    dir=$HOME
    wget http://luarocks.org/releases/luarocks-${luarocks_version}.tar.gz &>/dev/null
    tar zxpf luarocks-${luarocks_version}.tar.gz &>/dev/null
    cd luarocks-${luarocks_version}
    if [[ ${1} == "--no-null" ]]; then
        ./configure --prefix=$dir/.luarocks --sysconfdir=$dir/.luarocks/luarocks --force-config
        make bootstrap
    else
        ./configure --prefix=$dir/.luarocks --sysconfdir=$dir/.luarocks/luarocks --force-config &>/dev/null
        make bootstrap &>/dev/null
    fi
    cd ..
    if [[ -d "$HOME"/.luarocks ]]; then
        download_libs_lua
else	
        download_libs_lua
    fi
    for ((i=0;i<101;i++)); do
        printf "\rConfiguring... [%i%%]" $i
        sleep 0.007
    done
    printf "\nDone\n"
    rm -rf luarocks-*
}
function tgcli_config() {
tgcli="$THIS_DIR"/.TG-$1/tg-cli.config
if [ ! -f $tgcli ]; then
  printf '%s\n' "
default_profile = \"TG-$1\";
TG-$1 = {
  config_directory = \"$THIS_DIR/.TG-$1\";
  auth_file = \"$THIS_DIR/.TG-$1/auth\";
  test = false;
  msg_num = true;
  log_level = 2;
};
" > $tgcli
fi
}
function conf1() {
cli="$THIS_DIR"/.TG-$1/TG.lua
if [[ ! -f $cli ]]; then
echo "package.path = package.path..';../.luarocks/share/lua/5.2/?.lua;../.luarocks/share/lua/5.2/?/init.lua'
package.cpath = package.cpath..';../.luarocks/lib/lua/5.2/?.so'
redis = require('redis')
redis = redis.connect('127.0.0.1', 6379)
Ads_id = '$1'
require('TG')
function dl_cb (arg, data)
end
function tdcli_update_callback(data)
	Doing(data, Ads_id)
end" >> $cli
fi
}
function conf2() {
api="$THIS_DIR"/.TG-$1/API.lua
if [[ ! -f $api ]]; then
echo "package.path = package.path..';../.luarocks/share/lua/5.2/?.lua;../.luarocks/share/lua/5.2/?/init.lua'
package.cpath = package.cpath..';../.luarocks/lib/lua/5.2/?.so'
redis = require('redis')
redis = redis.connect('127.0.0.1', 6379)
URL = require('socket.url')
ltn12 = require('ltn12')
http = require('socket.http')
lgi = require('lgi')
https = require('ssl.https')
JSON = require('dkjson')
serpent = require('serpent')
notify = lgi.require('Notify')
notify.init ('Telegram updates')
chats = {}
day = 86400
Ads_id = '$1'
require('API')" >> $api
fi
}
function conf3() {
AP="$THIS_DIR"/AP-$1
if [ ! -f $AP ]; then
 echo -e "\n\033[38;5;27mYou must enter the token to create API robot : \n\033[38;5;208m\n\033[6;48m\n"
read -rp ' ' TKN
 printf "#!/bin/bash
 while true; do
      tmux kill-session -t AP-$1
            tmux new-session -s AP-$1 './telegram-cli -W --disable-link-preview -R -C -N -s ./.TG-$1/API.lua -p AP-$1 --bot=$TKN -L "$THIS_DIR"/.TG-$1/api.txt'
       tmux detach -s AP-$1
    sleep 5
  done" >> AP-$1
  chmod 777 AP-$1
fi
}
runbt() {
btdir="$THIS_DIR"/.TG-$1
if [ ! -d $btdir ]; then
 	mkdir -p "$THIS_DIR"/.TG-$1
 	tgcli_config $1
 	conf3 $1
 	conf1 $1
 	conf2 $1
fi
}
if [[ "$1" =~ ^[0-9]+$ ]] ; then
runbt $1
COUNTER=0
  while [ $COUNTER -lt 5 ]; do
       	 tmux kill-session -t TG-$1
	 	tmux new-session -s TG-$1 "./telegram-cli -W -R -C -v -s ./.TG-$1/TG.lua -N -I -c ./.TG-$1/tg-cli.config -p TG-$1 -L ./.TG-$1/log.txt"
         tmux detach -s TG-$1
    sleep 1
  done
fi
if [ "$1" = "upgrade" ]; then
	update
fi
if [ ! -f "telegram-cli" ]; then
	logo
	sudo apt-get -y update &>/dev/null; sudo apt-get -y upgrade &>/dev/null; dpkg -a --configure; sudo apt-get install -f &>/dev/null; sudo apt remove -y lua5.3 &>/dev/null; sudo apt -y autoremove &>/dev/null
 	chmod 777 TG
	installation ${2}
	rm -rf README.md
 	configure ${2}
	wget "https://valtman.name/files/telegram-cli-1215" &>/dev/null
	mv telegram-cli-1215 telegram-cli; chmod +x telegram-cli
  echo -e "\n\n\033[1;33mInstall Complete\033[0;00m\n"
  echo -e "\n\nCreate and Launch bot => \033[1;32mscreen -S nohup ./TG 1~9\033[0;00m\n"
  	sudo apt-get -y update &>/dev/null; sudo apt-get -y upgrade &>/dev/null; sudo apt autoremove -y &>/dev/null; sudo apt autoclean -y &>/dev/null
 	sudo service redis-server restart
 	sudo service redis-server start
fi
